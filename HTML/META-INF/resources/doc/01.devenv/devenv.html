<!DOCTYPE html>
<html>
	<head>
		<meta charset="UTF-8">
		<meta http-equiv="Pragma" content="no-cache">
		<meta http-equiv="Cache-Control" content="no-cache">
		<link type="text/css" href="../css/document.css" rel="stylesheet" />
		<title>開発環境構築</title>
	</head>
	<body>
		<h1><span>2.</span>開発環境構築</h1>
		<h2>Eclipseを用意する</h2>
		<p>
			日本語環境でよく使われているEclipse YYYY-MM Pleiades All in Oneを例に、開発環境の構築と簡単なアプリケーションの開発手順を説明します。
			基本的にjava11 + tomcat9の開発ができるものであれば、開発環境の構築が可能だと思います。
		</p>
		<p>
			<a href="http://mergedoc.osdn.jp/index.html#pleiades.html" target="_blank">Pleiades - Eclipse プラグイン日本語化プラグイン</a>のサイトから、Eclipse YYYY-MM Pleiades All in Oneを
			ダウンロードします。今回はpleiades-2020-03-java-win-64bit-jre_20200322.zipというファイル名のものを使用しました。
			このzipファイルをC:\eclipse\pleiades202003に展開します。
		</p>
		<p>
			展開したEclipseを起動し、ワークスペースC:\eclipse\workspaceを作成します。
			その後、JavaEEのパースペクティブを選択しサーバビューを開きます。
		</p>
		<figure>
			<figcaption>Eclipseを起動しサーバービューを表示した状態</figcaption>
			<img src="eclipse_start00.png" style="width:50%; height:50%;"/>
		</figure>
		<p>
			サーバービューのリンクをクリックし、新規にTomcat8サーバを追加します。
		</p>
		<figure>
			<figcaption>新規サーバダイアログ</figcaption>
			<img src="eclipse_start01.png" style="width:50%; height:50%;"/>
		</figure>
		<figure>
			<figcaption>Tomcat9(Java11)が追加された状態</figcaption>
			<img src="eclipse_start02.png" style="width:50%; height:50%;"/>
		</figure>
		<h2>データベースを用意する</h2>
		<p>
			dataforms2.jarを動かすためには、何らかのデータベースが必要になります。
			通常Tomcatからデータベースを使うには、サーバソフトを別にセットアップし、それに接続するためのjdbcドライバをTomcatにインストールします。<br/>
			サーバーソフトの設定はいろいろ面倒なので、ここでは組込み用Apache Derbyを使用します。<br/>
			<a href="https://db.apache.org/derby/" target="_blank">Apache Derby</a>のサイトよりdb-derby-&lt;version&gt;-bin.zipダウンロードし、
			その中に含まれているlib/derby*.jarを全てTOMCAT_HOME/lib(今回はC:\eclipse\pleiades202003\tomcat\9\lib)にコピーしてください。
			これだけでデータベース(apache derby)が使えるようになります。
		</p>
		<h2>Java mailのインストール</h2>
		<p>
			外部ユーザ登録機能を使う場合、JavaMailをTomcatにインストールします。
			<a href="https://github.com/javaee/javamail" target="_blank">https://github.com/javaee/javamail</a>のreleasesからjavax.mail.jarをダウンロードし、
			TOMCAT_HOME/libにコピーしてください。
			また、JavaBeans Activation Framework (JAF)も必要になります。
			<a href="https://github.com/javaee/activation" target="_blank">https://github.com/javaee/activation</a>のreleasesからjavax.activation.jarをダウンロードし、
			TOMCAT_HOME/libにコピーしてください。
		</p>
		<h2>プロジェクトの作成</h2>
		<p>
			<a href="https://github.com/takayanagi2087/dataforms2/releases" target="_blank">ブランクアプリケーションダウンロードサイト</a>から、dataforms2.jarのブランクアプリケーション(dfblank_xxx.war)をダウンロードして下さい。
			ダウンロードしたwarファイルは、eclipseプロジェクトとしてインポートすることができます。
			Eclipseのプロジェクト・エクスプローラーを右クリックし「インポート」→「WARファイル」とメニューを選択します。
		</p>
		<figure>
			<figcaption>WARインポートダイアログ</figcaption>
			<img src="eclipse_proj00.png" style="width:50%; height:50%;"/>
		</figure>
		<p>
			プロジェクト名はとりあえずsampleとし、ターゲットランタイムはTomcat9(java11)を選択し、「完了」ボタンを押してください。
		</p>
		<figure>
			<figcaption>インポートされたプロジェクト</figcaption>
			<img src="eclipse_proj01.png" style="width:50%; height:50%;"/>
		</figure>
		<p>
			作成したプロジェクトをTomcat9に追加します。サーバビューのTomcat9(Java11)を右クリックし、「追加および消去」を選択します。
		</p>
		<figure>
			<figcaption>Tomcat9(Java11)に作成したプロジェクトを追加</figcaption>
			<img src="eclipse_proj03.png" style="width:50%; height:50%;"/>
		</figure>
		<p>
			以下のダイアログが表示されるので、sampleを追加し完了ボタンを押下します。
		</p>
		<figure>
			<figcaption>追加および消去ダイアログ</figcaption>
			<img src="eclipse_proj04.png" style="width:50%; height:50%;"/>
		</figure>
		<p>
			この操作の結果、以下のようにTomcat9(Java11)にsampleプロジェクトが追加されます。
		</p>
		<figure>
			<figcaption>プロジェクト追加後のサーバビュー</figcaption>
			<img src="eclipse_proj05.png" style="width:50%; height:50%;"/>
		</figure>
		<p>
			これで空の動的WEBプロジェクトができました。
			作成されたプロジェクトは以下のようになっています。
		</p>
		<div class="filecaption">プロジェクトファイル一覧</div>
		<div class="wrappre">
			<pre>
./src
./src/log4j2.xml
./WebContent
./WebContent/frame
./WebContent/frame/default
./WebContent/frame/default/AppFrame.css
./WebContent/frame/default/AppFramePC.css
./WebContent/frame/default/AppFrameSP.css
./WebContent/frame/default/AppFrameTB.css
./WebContent/frame/messages
./WebContent/frame/messages/AppClientMessages.properties
./WebContent/frame/messages/AppClientMessages_ja.properties
./WebContent/frame/messages/AppMessages.properties
./WebContent/frame/messages/AppMessages_ja.properties
./WebContent/index.html
./WebContent/META-INF
./WebContent/META-INF/context.xml
./WebContent/META-INF/MANIFEST.MF
./WebContent/WEB-INF
./WebContent/WEB-INF/apachefop
./WebContent/WEB-INF/apachefop/fop.xconf
./WebContent/WEB-INF/dbRebuild
./WebContent/WEB-INF/dbRebuild/derby
./WebContent/WEB-INF/dbRebuild/derby/after.sql
./WebContent/WEB-INF/dbRebuild/derby/before.sql
./WebContent/WEB-INF/dbRebuild/mysql
./WebContent/WEB-INF/dbRebuild/mysql/after.sql
./WebContent/WEB-INF/dbRebuild/mysql/before.sql
./WebContent/WEB-INF/dbRebuild/oracle
./WebContent/WEB-INF/dbRebuild/oracle/after.sql
./WebContent/WEB-INF/dbRebuild/oracle/before.sql
./WebContent/WEB-INF/dbRebuild/pgsql
./WebContent/WEB-INF/dbRebuild/pgsql/after.sql
./WebContent/WEB-INF/dbRebuild/pgsql/before.sql
./WebContent/WEB-INF/lib
./WebContent/WEB-INF/lib/batik-all-1.12.jar
./WebContent/WEB-INF/lib/commons-codec-1.13.jar
./WebContent/WEB-INF/lib/commons-collections4-4.4.jar
./WebContent/WEB-INF/lib/commons-compress-1.19.jar
./WebContent/WEB-INF/lib/commons-fileupload-1.4.jar
./WebContent/WEB-INF/lib/commons-io-1.3.1.jar
./WebContent/WEB-INF/lib/commons-lang3-3.10.jar
./WebContent/WEB-INF/lib/commons-logging-1.0.4.jar
./WebContent/WEB-INF/lib/commons-logging-1.2.jar
./WebContent/WEB-INF/lib/commons-math3-3.6.1.jar
./WebContent/WEB-INF/lib/commons-text-1.8.jar
./WebContent/WEB-INF/lib/commons-validator-1.6.jar
./WebContent/WEB-INF/lib/curvesapi-1.06.jar
./WebContent/WEB-INF/lib/dataforms2.jar
./WebContent/WEB-INF/lib/fontbox-2.0.16.jar
./WebContent/WEB-INF/lib/fop.jar
./WebContent/WEB-INF/lib/jsonic-1.3.10.jar
./WebContent/WEB-INF/lib/log4j-api-2.13.2.jar
./WebContent/WEB-INF/lib/log4j-core-2.13.2.jar
./WebContent/WEB-INF/lib/poi-4.1.2.jar
./WebContent/WEB-INF/lib/poi-excelant-4.1.2.jar
./WebContent/WEB-INF/lib/poi-ooxml-4.1.2.jar
./WebContent/WEB-INF/lib/poi-ooxml-schemas-4.1.2.jar
./WebContent/WEB-INF/lib/poi-scratchpad-4.1.2.jar
./WebContent/WEB-INF/lib/serializer-2.7.2.jar
./WebContent/WEB-INF/lib/SparseBitSet-1.2.jar
./WebContent/WEB-INF/lib/xalan-2.7.2.jar
./WebContent/WEB-INF/lib/xercesImpl-2.12.0.jar
./WebContent/WEB-INF/lib/xmlbeans-3.1.0.jar
./WebContent/WEB-INF/lib/xmlgraphics-commons-2.4.jar
./WebContent/WEB-INF/web.xml
			</pre>
		</div>
		<p>
			「/src」以下は、log4j2の設定ファイル(log4j2.xml)のみで、Javaのソースファイルはありません。
			「/WebContent/WEB-INF/lib」には、dataforms2.jarとdataforms2.jarが依存しているjarファイルが入っています。
			Excel出力が不要であれば、poi関連のjarを削除することができます。
			また、PDF出力が不要であれば、FOP関連のjarを削除することができます。
		</p>
		<p>
			「/WebContent/META-INF/context.xml」には、テータベース(組込みdevby用)への接続設定が記載されています。
			もしPostgreSQL,MySQL,Oracle等のデータベースを使用する場合、Tomcat9に該当のjdbcドライバをインストールしcontext.xmlを書き換えてください。
			コメントに各種DBサーバの設定例を記述してありますので参考にしてください。
		</p>
		<p>
			Apache derbyのJDBCドライバは制約違反発生時の制約名称を取得するAPIを持っているため、追加設定は必要ありません。
			しかし、その他のJDBCドライバにはそのようなAPIがないため、エラーメッセージから制約名を取得するようになっています。
			そのため、duplicateErrorMessageに一意制約時のエラーメッセージのパターン、
			foreignKeyErrorMessageに外部制約違反時のエラーメッセージのパターンを記述する必要があります。
			このメッセージはOSの言語設定やDBサーバのバージョンによって異なる可能性があるため、
			制約名が取得できない場合は適切に変更する必要があります。
		</p>
		<div class="filecaption">/WebContent/META-INF/context.xml</div>
		<div class="wrappre">
			<pre>

&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;
&lt;!DOCTYPE Context&gt;
&lt;Context&gt;
	&lt;!--
		&#32068;&#12415;&#36796;&#12415;Apache derby&#29992;&#12398;&#25509;&#32154;&#35373;&#23450;
		Apache derby&#12398;JDBC&#12489;&#12521;&#12452;&#12496;&#12399;&#21046;&#32004;&#21517;&#31216;&#12434;&#21462;&#24471;&#12377;&#12427;API&#12364;&#12354;&#12427;&#12383;&#12417;
		duplicateErrorMessage&#12392;foreignKeyErrorMessage&#12398;&#35373;&#23450;&#12399;&#19981;&#35201;&#12290;
	 --&gt;
	&lt;Resource auth=&quot;Container&quot;
		driverClassName=&quot;org.apache.derby.jdbc.EmbeddedDriver&quot;
		name=&quot;jdbc/dfdb&quot; type=&quot;javax.sql.DataSource&quot;
		url=&quot;jdbc:derby:./javadb/blankdb;create=true&quot;
		username=&quot;&quot; password=&quot;&quot; /&gt;
	&lt;!--
		Apache derby&#12493;&#12483;&#12488;&#12527;&#12540;&#12463;&#12469;&#12540;&#12496;&#29992;&#12398;&#25509;&#32154;&#35373;&#23450;
		Apache derby&#12398;JDBC&#12489;&#12521;&#12452;&#12496;&#12399;&#21046;&#32004;&#21517;&#31216;&#12434;&#21462;&#24471;&#12377;&#12427;API&#12364;&#12354;&#12427;&#12383;&#12417;
		duplicateErrorMessage&#12392;foreignKeyErrorMessage&#12398;&#35373;&#23450;&#12399;&#19981;&#35201;&#12290;
	--&gt;
	&lt;!--
	&lt;Resource auth=&quot;Container&quot; driverClassName=&quot;org.apache.derby.jdbc.ClientDriver&quot;
		maxActive=&quot;8&quot; maxIdle=&quot;4&quot; name=&quot;jdbc/dfdb&quot; type=&quot;javax.sql.DataSource&quot;
		url=&quot;jdbc:derby://localhost:1527/javadb/blankdb;create=true&quot; username=&quot;APP&quot;
		password=&quot;password&quot; /&gt;
	--&gt;

	&lt;!--
		PostgreSQL&#29992;&#12398;&#25509;&#32154;&#35373;&#23450;
		&#21046;&#32004;&#36949;&#21453;&#12398;&#22580;&#21512;&#12289;&#21046;&#32004;&#21517;&#12399;&#12456;&#12521;&#12540;&#12513;&#12483;&#12475;&#12540;&#12472;&#12363;&#12425;&#21462;&#24471;&#12377;&#12427;&#12398;&#12391;&#12289;
		&#19968;&#24847;&#21046;&#32004;&#21517;&#21462;&#24471;&#29992;&#12398;&#27491;&#35215;&#34920;&#29694;&#12434;duplicateErrorMessage&#12289;
		&#22806;&#37096;&#12461;&#12540;&#21046;&#32004;&#29992;&#21517;&#21462;&#24471;&#29992;&#12398;&#27491;&#35215;&#34920;&#29694;&#12434;foreignKeyErrorMessage&#12395;&#35373;&#23450;&#12375;&#12414;&#12377;&#12290;
	 --&gt;
	&lt;!--
	&lt;Resource name=&quot;jdbc/dfdb&quot; type=&quot;javax.sql.DataSource&quot;
		auth=&quot;Container&quot; driverClassName=&quot;org.postgresql.Driver&quot;
		url=&quot;jdbc:postgresql://192.168.56.102:5432/blankdb&quot; username=&quot;postgres&quot;
		password=&quot;&quot; /&gt;
	&lt;Environment name=&quot;duplicateErrorMessage&quot; value=&quot;&#19968;&#24847;&#24615;&#21046;&#32004;&quot;(.+?)&quot;&#12395;&#36949;&#21453;&quot; type=&quot;java.lang.String&quot; override=&quot;false&quot;/&gt;
	&lt;Environment name=&quot;foreignKeyErrorMessage&quot; value=&quot;&#22806;&#37096;&#12461;&#12540;&#21046;&#32004;&quot;(.+?)&quot;&#12395;&#36949;&#21453;&quot; type=&quot;java.lang.String&quot; override=&quot;false&quot;/&gt;
	--&gt;

	&lt;!--
		MariaDB&#29992;&#25509;&#32154;&#35373;&#23450;
		MariaDB&#29992;&#12398;jdbc&#12489;&#12521;&#12452;&#12496;&#12540;&#12434;&#20351;&#29992;&#12377;&#12427;&#22580;&#21512;&#12398;&#35373;&#23450;&#12391;&#12377;&#12290;
		&#21046;&#32004;&#36949;&#21453;&#12398;&#22580;&#21512;&#12289;&#21046;&#32004;&#21517;&#12399;&#12456;&#12521;&#12540;&#12513;&#12483;&#12475;&#12540;&#12472;&#12363;&#12425;&#21462;&#24471;&#12377;&#12427;&#12398;&#12391;&#12289;
		&#19968;&#24847;&#21046;&#32004;&#21517;&#21462;&#24471;&#29992;&#12398;&#27491;&#35215;&#34920;&#29694;&#12434;duplicateErrorMessage&#12289;
		&#22806;&#37096;&#12461;&#12540;&#21046;&#32004;&#29992;&#21517;&#21462;&#24471;&#29992;&#12398;&#27491;&#35215;&#34920;&#29694;&#12434;foreignKeyErrorMessage&#12395;&#35373;&#23450;&#12375;&#12414;&#12377;&#12290;
	 --&gt;
	&lt;!--
	&lt;Resource name=&quot;jdbc/dfdb&quot; auth=&quot;Container&quot; type=&quot;javax.sql.DataSource&quot;
		username=&quot;dfuser&quot; password=&quot;password&quot; driverClassName=&quot;org.mariadb.jdbc.Driver&quot;
		url=&quot;jdbc:mysql://192.168.56.102/blankdb?useOldAliasMetadataBehavior=true&quot; /&gt;
	&lt;Environment name=&quot;duplicateErrorMessage&quot; value=&quot;for key '(.+?)'$&quot; type=&quot;java.lang.String&quot; override=&quot;false&quot;/&gt;
	&lt;Environment name=&quot;foreignKeyErrorMessage&quot; value=&quot;CONSTRAINT `(.+?)` FOREIGN KEY&quot; type=&quot;java.lang.String&quot; override=&quot;false&quot;/&gt;
	--&gt;

	&lt;!--
		MySQL&#29992;&#25509;&#32154;&#35373;&#23450;
		MySQL&#29992;&#12398;jdbc&#12489;&#12521;&#12452;&#12496;&#12540;&#12434;&#20351;&#29992;&#12377;&#12427;&#22580;&#21512;&#12398;&#35373;&#23450;&#12391;&#12377;&#12290;
		&#21046;&#32004;&#36949;&#21453;&#12398;&#22580;&#21512;&#12289;&#21046;&#32004;&#21517;&#12399;&#12456;&#12521;&#12540;&#12513;&#12483;&#12475;&#12540;&#12472;&#12363;&#12425;&#21462;&#24471;&#12377;&#12427;&#12398;&#12391;&#12289;
		&#19968;&#24847;&#21046;&#32004;&#21517;&#21462;&#24471;&#29992;&#12398;&#27491;&#35215;&#34920;&#29694;&#12434;duplicateErrorMessage&#12289;
		&#22806;&#37096;&#12461;&#12540;&#21046;&#32004;&#29992;&#21517;&#21462;&#24471;&#29992;&#12398;&#27491;&#35215;&#34920;&#29694;&#12434;foreignKeyErrorMessage&#12395;&#35373;&#23450;&#12375;&#12414;&#12377;&#12290;
	--&gt;
	&lt;!--
	&lt;Resource name=&quot;jdbc/dfdb&quot; auth=&quot;Container&quot; type=&quot;javax.sql.DataSource&quot;
		username=&quot;dfuser&quot; password=&quot;password&quot; driverClassName=&quot;com.mysql.jdbc.Driver&quot;
		url=&quot;jdbc:mysql://192.168.56.102/blankdb?generateSimpleParameterMetadata=true&amp;useInformationSchema=true&amp;useOldAliasMetadataBehavior=true&amp;characterEncoding=utf8&quot; /&gt;
	&lt;Environment name=&quot;duplicateErrorMessage&quot; value=&quot;for key '(.+?)'$&quot; type=&quot;java.lang.String&quot; override=&quot;false&quot;/&gt;
	&lt;Environment name=&quot;foreignKeyErrorMessage&quot; value=&quot;CONSTRAINT `(.+?)` FOREIGN KEY&quot; type=&quot;java.lang.String&quot; override=&quot;false&quot;/&gt;
	--&gt;

	&lt;!--
		ORACLE&#29992;&#12398;&#25509;&#32154;&#35373;&#23450;
		&#21046;&#32004;&#36949;&#21453;&#12398;&#22580;&#21512;&#12289;&#21046;&#32004;&#21517;&#12399;&#12456;&#12521;&#12540;&#12513;&#12483;&#12475;&#12540;&#12472;&#12363;&#12425;&#21462;&#24471;&#12377;&#12427;&#12398;&#12391;&#12289;
		&#19968;&#24847;&#21046;&#32004;&#21517;&#21462;&#24471;&#29992;&#12398;&#27491;&#35215;&#34920;&#29694;&#12434;duplicateErrorMessage&#12289;
		&#22806;&#37096;&#12461;&#12540;&#21046;&#32004;&#29992;&#21517;&#21462;&#24471;&#29992;&#12398;&#27491;&#35215;&#34920;&#29694;&#12434;foreignKeyErrorMessage&#12395;&#35373;&#23450;&#12375;&#12414;&#12377;&#12290;
	--&gt;
	&lt;!--
	&lt;Resource name=&quot;jdbc/dfdb&quot; auth=&quot;Container&quot;
		type=&quot;javax.sql.DataSource&quot; driverClassName=&quot;oracle.jdbc.OracleDriver&quot;
		url=&quot;jdbc:oracle:thin:@192.168.56.102:1521:xe&quot;
		username=&quot;dfuser&quot; password=&quot;password&quot;/&gt;
	&lt;Environment name=&quot;duplicateErrorMessage&quot; value=&quot;constraint \(.+?\.(.+?)\) violated&quot; type=&quot;java.lang.String&quot; override=&quot;false&quot;/&gt;
	&lt;Environment name=&quot;foreignKeyErrorMessage&quot; value=&quot;constraint \(.+?\.(.+?)\) violated &quot; type=&quot;java.lang.String&quot; override=&quot;false&quot;/&gt;
	--&gt;
&lt;/Context&gt;

			</pre>
		</div>
		<p>
			「/WebContent/WEB-INF/web.xml」にはアプリケーションの各種設定が記録されています。
			dataforms2.jar固有の設定も、web.xmlに記述するようになっています。
			設定項目はweb.xml中のコメントを参照してください。
			この状態でプロジェクトのクリーンビルドを行い、Tomcat9を起動してください。
		</p>
		<figure>
			<figcaption>Tomcat9を起動した状態</figcaption>
			<img src="eclipse_proj07.png" style="width:50%; height:50%;"/>
		</figure>
		<h2>プロジェクトの実行</h2>
		<p>
			tomcatを起動した後、WEBブラウザから"http://localhost:8080/sample/"をアクセスすると以下のページが表示されます。
			dataforms2.jarの中には、Webアプリケーションを構築するためのライブラリだけでなく、ユーザ管理などの基本機能や開発ツールを含んでいます。
			初回の起動時にはデータベースの初期設定を行い、開発者権限を持ったユーザの登録するためのページが表示されます。
		</p>
		<figure>
			<figcaption>データベース初期設定</figcaption>
			<img src="eclipse_proj08.png" style="width:50%; height:50%;"/>
		</figure>
		<p>
			このページで開発者の情報を入力すると、データベースに必要なテーブルが作成され、開発者が登録されます。
			データベースが作成されると、ログイン画面が表示されます。
		</p>
		<figure>
			<figcaption>ログイン画面</figcaption>
			<img src="eclipse_proj09.png" style="width:50%; height:50%;"/>
		</figure>
		<p>
			この画面から、先ほど登録した開発者権限を持つユーザでログインすることができます。
			開発者権限でログインすると、以下のようなサイトマップが表示されます。
		</p>
		<figure>
			<figcaption>サイトマップ</figcaption>
			<img src="eclipse_proj10.png" style="width:50%; height:50%;"/>
		</figure>
		<hr/>
	</body>
</html>