<!DOCTYPE html>
<html>
	<head>
		<meta charset="UTF-8">
		<link type="text/css" href="../css/document.css" rel="stylesheet" />
		<title>DAOパッケージ</title>
	</head>
	<body>
		<h1><span>6.</span>Table,Query,Dao</h1>
		<p>
			この記事でdataforms.daoパッケージのTable,Query,Daoクラスについて解説していきます。
			Tableクラスはテータベース中のテーブルの構造を定義します。
			QueryクラスはSQLのselect文に対応するクラスです。
			複数のテーブルクラスを結合した問合せクラスを作成することができるようになっています。
			DaoクラスはTableクラスのレコード追加・更新・削除、Queryクラスで定義した問合せを実行する機能を持っています。
			dataforms.daoパッケージは複数のデータベースサーバ(Apache derby,PostgreSQL,MySQL,Oracle)に対応しています。
			各データベースのサーバのSQLには方言があり、直接データベースをアクセスする場合その文法の違いを考慮してSQLを記述する必要がありました。
			データベースの操作はJavaのクラスのみで行い、SQLを使うことはほとんどありません。
			そのため選択したデータベースに依存するコードを排除することができます。
			実際「単体テストまでは環境構築が簡単なApache derbyで作業し、結合テスト以降はPostgreSQLサーバを用意してテスト」という開発を問題なく進めた実績があります。
		</p>
		<h2>Tomcatのデータベース接続設定</h2>
		<p>
			テータベースの接続設定はTomcat等のアプリケーションサーバ側で行います。
			Tomcat9を例に設定のポイントを説明します。
		</p>
		<h3>データベースの接続設定の記述場所</h3>
		<p>
			dfblank_xxx.warをインポートしたプロジェクトでは、WebContent/META-INF/content.xmlというファイルが存在しています。
			このファイルにデータベースの接続設定が入っています。
			WebContent/META-INF/content.xmlはwarファイルの中に含まれているファイルです。
			そのためWebアプリケーションにDBへの接続設定を含めてリリースする場合に使用します。
			runwar等を使用してスタンドアロンアプリケーションのように使用する場合、
			WebContent/META-INF/content.xmlを使用します。
		</p>
		<p>
			Tomcat9ではデータベースの接続設定を$TOMCAT_HOME/conf/context.xmlにも記述することができます。
			(Eclipse上のTomcatの場合"Servers/ローカルホスト の Tomcat9 (Java11)-config/context.xml"がこれに当たります。)
			WebContent/META-INF/content.xmlデータベースの接続設定を削除し、$TOMCAT_HOME/conf/context.xmlにデータベース接続設定を移動しても同様に動作します。
			この状態で*.warファイルを作成すると、*.warファイル中に接続設定は存在しないため、Tomcatのデータベース接続設定が使用されます。
			Eclipse上のTomcatはテスト用のデータベースに接続し、本番用サーバ上のTomcatには本番用データベースに接続するように設定しておきます。
			こうしておくと、Eclipseで*.warファイルを作成し本番用サーバの$TOMCAT_HOME/webappsにコピーするだけで、本番環境へのデプロイが完了します。
		</p>
		<h3>データベース接続設定の記述内容</h3>
		<p>
			dfblank_xxx.warに入っている、META-INF/context.xmlは以下の様になっています。
		</p>
		<div class="filecaption">context.xmlの内容</div>
		<div class="wrappre">
			<pre>
&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;
&lt;!DOCTYPE Context&gt;&lt;Context addWebinfClassesResources=&quot;true&quot;&gt;
	&lt;!--
		&#32068;&#12415;&#36796;&#12415;Apache derby&#29992;&#12398;&#25509;&#32154;&#35373;&#23450;
		Apache derby&#12398;JDBC&#12489;&#12521;&#12452;&#12496;&#12399;&#21046;&#32004;&#21517;&#31216;&#12434;&#21462;&#24471;&#12377;&#12427;API&#12364;&#12354;&#12427;&#12383;&#12417;
		duplicateErrorMessage&#12392;foreignKeyErrorMessage&#12398;&#35373;&#23450;&#12399;&#19981;&#35201;&#12290;
	 --&gt;
	&lt;Resource auth=&quot;Container&quot;
		driverClassName=&quot;org.apache.derby.jdbc.EmbeddedDriver&quot;
		name=&quot;jdbc/dfdb&quot; type=&quot;javax.sql.DataSource&quot;
		url=&quot;jdbc:derby:/javadb/dfdbC;create=true&quot;
		username=&quot;&quot; password=&quot;&quot; /&gt;
	&lt;!--
		Apache derby&#12493;&#12483;&#12488;&#12527;&#12540;&#12463;&#12469;&#12540;&#12496;&#29992;&#12398;&#25509;&#32154;&#35373;&#23450;
		Apache derby&#12398;JDBC&#12489;&#12521;&#12452;&#12496;&#12399;&#21046;&#32004;&#21517;&#31216;&#12434;&#21462;&#24471;&#12377;&#12427;API&#12364;&#12354;&#12427;&#12383;&#12417;
		duplicateErrorMessage&#12392;foreignKeyErrorMessage&#12398;&#35373;&#23450;&#12399;&#19981;&#35201;&#12290;
	--&gt;
	&lt;!--
	&lt;Resource auth=&quot;Container&quot; driverClassName=&quot;org.apache.derby.jdbc.ClientDriver&quot;
		maxActive=&quot;8&quot; maxIdle=&quot;4&quot; name=&quot;jdbc/dfdb&quot; type=&quot;javax.sql.DataSource&quot;
		url=&quot;jdbc:derby://localhost:1527/javadb/blank;create=true&quot; username=&quot;APP&quot;
		password=&quot;password&quot; /&gt;
	--&gt;

	&lt;!--
		PostgreSQL&#29992;&#12398;&#25509;&#32154;&#35373;&#23450;
		&#21046;&#32004;&#36949;&#21453;&#12398;&#22580;&#21512;&#12289;&#21046;&#32004;&#21517;&#12399;&#12456;&#12521;&#12540;&#12513;&#12483;&#12475;&#12540;&#12472;&#12363;&#12425;&#21462;&#24471;&#12377;&#12427;&#12398;&#12391;&#12289;
		&#19968;&#24847;&#21046;&#32004;&#21517;&#21462;&#24471;&#29992;&#12398;&#27491;&#35215;&#34920;&#29694;&#12434;duplicateErrorMessage&#12289;
		&#22806;&#37096;&#12461;&#12540;&#21046;&#32004;&#29992;&#21517;&#21462;&#24471;&#29992;&#12398;&#27491;&#35215;&#34920;&#29694;&#12434;foreignKeyErrorMessage&#12395;&#35373;&#23450;&#12375;&#12414;&#12377;&#12290;
	 --&gt;
	&lt;!--
	&lt;Resource name=&quot;jdbc/dfdb&quot; type=&quot;javax.sql.DataSource&quot;
		auth=&quot;Container&quot; driverClassName=&quot;org.postgresql.Driver&quot;
		url=&quot;jdbc:postgresql://192.168.56.102:5432/dfdb&quot; username=&quot;postgres&quot;
		password=&quot;&quot; /&gt;
	&lt;Environment name=&quot;duplicateErrorMessage&quot; value=&quot;&#19968;&#24847;&#24615;&#21046;&#32004;&quot;(.+?)&quot;&#12395;&#36949;&#21453;&quot; type=&quot;java.lang.String&quot; override=&quot;false&quot;/&gt;
	&lt;Environment name=&quot;foreignKeyErrorMessage&quot; value=&quot;&#22806;&#37096;&#12461;&#12540;&#21046;&#32004;&quot;(.+?)&quot;&#12395;&#36949;&#21453;&quot; type=&quot;java.lang.String&quot; override=&quot;false&quot;/&gt;
	--&gt;

	&lt;!--
		MariaDB&#29992;&#25509;&#32154;&#35373;&#23450;
		MariaDB&#29992;&#12398;jdbc&#12489;&#12521;&#12452;&#12496;&#12540;&#12434;&#20351;&#29992;&#12377;&#12427;&#22580;&#21512;&#12398;&#35373;&#23450;&#12391;&#12377;&#12290;
		&#21046;&#32004;&#36949;&#21453;&#12398;&#22580;&#21512;&#12289;&#21046;&#32004;&#21517;&#12399;&#12456;&#12521;&#12540;&#12513;&#12483;&#12475;&#12540;&#12472;&#12363;&#12425;&#21462;&#24471;&#12377;&#12427;&#12398;&#12391;&#12289;
		&#19968;&#24847;&#21046;&#32004;&#21517;&#21462;&#24471;&#29992;&#12398;&#27491;&#35215;&#34920;&#29694;&#12434;duplicateErrorMessage&#12289;
		&#22806;&#37096;&#12461;&#12540;&#21046;&#32004;&#29992;&#21517;&#21462;&#24471;&#29992;&#12398;&#27491;&#35215;&#34920;&#29694;&#12434;foreignKeyErrorMessage&#12395;&#35373;&#23450;&#12375;&#12414;&#12377;&#12290;
	 --&gt;
	&lt;!--
	&lt;Resource name=&quot;jdbc/dfdb&quot; auth=&quot;Container&quot; type=&quot;javax.sql.DataSource&quot;
		username=&quot;dfuser&quot; password=&quot;password&quot; driverClassName=&quot;org.mariadb.jdbc.Driver&quot;
		url=&quot;jdbc:mysql://192.168.56.102/dfdb?useOldAliasMetadataBehavior=true&quot; /&gt;
	&lt;Environment name=&quot;duplicateErrorMessage&quot; value=&quot;for key '(.+?)'$&quot; type=&quot;java.lang.String&quot; override=&quot;false&quot;/&gt;
	&lt;Environment name=&quot;foreignKeyErrorMessage&quot; value=&quot;CONSTRAINT `(.+?)` FOREIGN KEY&quot; type=&quot;java.lang.String&quot; override=&quot;false&quot;/&gt;
	--&gt;

	&lt;!--
		MySQL&#29992;&#25509;&#32154;&#35373;&#23450;
		MySQL&#29992;&#12398;jdbc&#12489;&#12521;&#12452;&#12496;&#12540;&#12434;&#20351;&#29992;&#12377;&#12427;&#22580;&#21512;&#12398;&#35373;&#23450;&#12391;&#12377;&#12290;
		&#21046;&#32004;&#36949;&#21453;&#12398;&#22580;&#21512;&#12289;&#21046;&#32004;&#21517;&#12399;&#12456;&#12521;&#12540;&#12513;&#12483;&#12475;&#12540;&#12472;&#12363;&#12425;&#21462;&#24471;&#12377;&#12427;&#12398;&#12391;&#12289;
		&#19968;&#24847;&#21046;&#32004;&#21517;&#21462;&#24471;&#29992;&#12398;&#27491;&#35215;&#34920;&#29694;&#12434;duplicateErrorMessage&#12289;
		&#22806;&#37096;&#12461;&#12540;&#21046;&#32004;&#29992;&#21517;&#21462;&#24471;&#29992;&#12398;&#27491;&#35215;&#34920;&#29694;&#12434;foreignKeyErrorMessage&#12395;&#35373;&#23450;&#12375;&#12414;&#12377;&#12290;
	--&gt;
	&lt;!--
	&lt;Resource name=&quot;jdbc/dfdb&quot; auth=&quot;Container&quot; type=&quot;javax.sql.DataSource&quot;
		username=&quot;dfuser&quot; password=&quot;password&quot; driverClassName=&quot;com.mysql.jdbc.Driver&quot;
		url=&quot;jdbc:mysql://192.168.56.102/dfdb?generateSimpleParameterMetadata=true&amp;useInformationSchema=true&amp;useOldAliasMetadataBehavior=true&amp;characterEncoding=utf8&quot; /&gt;
	&lt;Environment name=&quot;duplicateErrorMessage&quot; value=&quot;for key '(.+?)'$&quot; type=&quot;java.lang.String&quot; override=&quot;false&quot;/&gt;
	&lt;Environment name=&quot;foreignKeyErrorMessage&quot; value=&quot;CONSTRAINT `(.+?)` FOREIGN KEY&quot; type=&quot;java.lang.String&quot; override=&quot;false&quot;/&gt;
	--&gt;

	&lt;!--
		ORACLE&#29992;&#12398;&#25509;&#32154;&#35373;&#23450;
		&#21046;&#32004;&#36949;&#21453;&#12398;&#22580;&#21512;&#12289;&#21046;&#32004;&#21517;&#12399;&#12456;&#12521;&#12540;&#12513;&#12483;&#12475;&#12540;&#12472;&#12363;&#12425;&#21462;&#24471;&#12377;&#12427;&#12398;&#12391;&#12289;
		&#19968;&#24847;&#21046;&#32004;&#21517;&#21462;&#24471;&#29992;&#12398;&#27491;&#35215;&#34920;&#29694;&#12434;duplicateErrorMessage&#12289;
		&#22806;&#37096;&#12461;&#12540;&#21046;&#32004;&#29992;&#21517;&#21462;&#24471;&#29992;&#12398;&#27491;&#35215;&#34920;&#29694;&#12434;foreignKeyErrorMessage&#12395;&#35373;&#23450;&#12375;&#12414;&#12377;&#12290;
	--&gt;
	&lt;!--
	&lt;Resource name=&quot;jdbc/dfdb&quot; auth=&quot;Container&quot;
		type=&quot;javax.sql.DataSource&quot; driverClassName=&quot;oracle.jdbc.OracleDriver&quot;
		url=&quot;jdbc:oracle:thin:@192.168.56.102:1521:xe&quot;
		username=&quot;dfuser&quot; password=&quot;password&quot;/&gt;
	&lt;Environment name=&quot;duplicateErrorMessage&quot; value=&quot;constraint \(.+?\.(.+?)\) violated&quot; type=&quot;java.lang.String&quot; override=&quot;false&quot;/&gt;
	&lt;Environment name=&quot;foreignKeyErrorMessage&quot; value=&quot;constraint \(.+?\.(.+?)\) violated &quot; type=&quot;java.lang.String&quot; override=&quot;false&quot;/&gt;
	--&gt;
&lt;/Context&gt;
			</pre>
		</div>
		<p>
			デフォルト設定ではApache derbyの組み込みドライバの設定が有効になっており、
			PostgreSQL,MySQL(MariaDB),Oracleの設定例はコメントで記述されています。
			接続するデータベースに対応する接続設定を有効にしてください。
		</p>
		<p>
			Apache derbyのJDBCドライバは制約違反発生時の制約名称を取得するAPIを持っているため、追加設定は必要ありません。
			しかし、その他のJDBCドライバにはそのようなAPIがないため、エラーメッセージから制約名を取得するようになっています。
			そのため、duplicateErrorMessageに一意制約時のエラーメッセージのパターン、
			foreignKeyErrorMessageに外部制約違反時のエラーメッセージのパターンを記述する必要があります。
			このメッセージはOSの言語設定やDBサーバのバージョンによって異なる可能性があるため、
			制約名が取得できない場合は適切に変更する必要があります。
		</p>
		<h3>web.xmlの設定</h3>
		
		<h2>Tableクラスの</h2>
		<h2>TableクラスとDaoクラス</h2>
		<h2>問合せクラス</h2>
		<h2>問合せクラスとDaoクラス</h2>
		<h2>QuerySetDaoクラス解説</h2>
	</body>
</html>