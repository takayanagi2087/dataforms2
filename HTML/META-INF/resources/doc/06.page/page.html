<!DOCTYPE html>
<html>
	<head>
		<meta charset="UTF-8">
		<title>Page,Form,HtmlTable</title>
		<link type="text/css" href="../css/document.css" rel="stylesheet" />
	</head>
	<body>
		<h1><span>7.</span>Page,Form,HtmlTable</h1>
		<h2>ページ内のフォームの連携</h2>
		<p>
			dataforms2.jarではページの標準的な構成とその動作が決まっています。
			ページには通常以下の3種類のフォームが配置されます。
		</p>
		<table>
			<caption>
				ページに配置する主要フォーム
			</caption>
			<thead>
				<tr>
					<th style="width:40px;">No.</th>
					<th style="width:200px;">基本クラス</th>
					<th style="width:100px;">ID</th>
					<th style="width: 300px;">用途</th>
				</tr>
			</thead>
			<tbody>
				<tr>
					<td style="text-align: right;">1</td>
					<td>QueryForm</td>
					<td>queryForm</td>
					<td>
						データベースに問い合わせる際の条件を入力します。
					</td>
				</tr>
				<tr>
					<td style="text-align: right;">2</td>
					<td>QueryResultForm</td>
					<td>queryResultForm</td>
					<td>
						QueryFormで入力した条件に従ってデータベースを検索し、その結果を表示します。
					</td>
				</tr>
				<tr>
					<td style="text-align: right;">3</td>
					<td>EditForm</td>
					<td>editForm</td>
					<td>
						QueryResultFormに表示された結果から選択したレコードを表示し、
						その内容を修正・登録します。
					</td>
				</tr>
			</tbody>
		</table>
		<p>
			QueryFormに入力された検索条件はバリデーションされたのち、QueryResultFormに渡されます。
			QueryResultFormはこの条件を使用してデータベースの問合せを行い、その結果を一覧表示します。
			一覧表示されている結果の一つを選択すると、そのキー情報をEditFormに渡して表示します。
			EditFormはキー情報をもとに編集対象データを取得し、その内容を編集した後データを更新します。
		</p>
		<p>
			大抵のアプリケーションはこの流れの全部または一部に当てはまると思います。
			EditFormの配置を省略すると、問合せ条件の入力から問合せ結果の表示するページになります。
			QueryResultFormの配置を省略すると、問合せ条件を直接EditFormに渡しその条件に合った
			データを更新するページになります。
			また、QueryFormを省略すると、いきなり該当データをQueryResultFormに表示するページになります。
		</p>
		<p>
			この流れに沿わないページを作る場合、この3種類のFormをすべて配置せずに、
			Formクラスから派生した独自のクラスを作成して配置することになります。
			しかし、このようなページを作ることはほとんどないと思います。
		</p>
		<h2>QuerySetDaoの機能</h2>
		<p>
			この3種類のフォームのデータベースアクセスを担当するのが、Daoから派生したQuerySetDaoクラスになります。
			このDaoクラスは開発ツールの「DAO Javaクラス作成」を使用して作成します。
		</p>
		<figure>
			<figcaption>Dao Javaクラス作成</figcaption>
			<img src="../02.devtool/dao1.png" style="width:50%; height:50%;"/>
		</figure>
		<p>
			この画面では一覧取得用問合せと編集フォーム用問合せを指定します。
			このフィールドには問合せだけでなくテーブルクラスも指定できます。
			テーブルクラスを指定した場合、自動的にSingleTableQueryという問合せクラスを生成して登録します。
		</p>
		<p>
			QueryResultFormは一覧取得用問合せを使用してデータを取得します。
			この時、QueryFormに配置されたフィールドのリストと入力されたデータのマップを、
			指定された問合せのsetConditionFieldList、setConditionDataに設定します。
		</p>
		<p>
			EditFormは編集フォーム用問合せを使用して編集するデータを取得します。
			編集フォーム用問合せは1レコード編集と複数レコード編集の2パターンがあります。
		</p>
		<h3>1レコード編集のページ</h3>
		<p>
			1レコード編集の場合、QueryResultFormから渡された主キーの情報を編集フォーム用問合せに渡して編集データを取得します。
			このモードでは関連する問合せやテーブルを複数指定することができます。
			これらの問合せのフィールドには指定された主キーのフィールドを含んだものである必要があります。
		</p>
		<p>
			「6.Table,Query,Dao」で作成したJoinTestTableはSampleIdFielを持っているので、SampleFieldの関連するテーブルといえます。
			SampleTableとJoinTestTableを同時に編集するページを作る場合、以下のような設定でDaoを作成します。
		</p>
		<figure>
			<figcaption>Dao Javaクラス作成</figcaption>
			<img src="dao1.png" style="width:50%; height:50%;"/>
		</figure>
		<p>
			上記の画面で作成したDaoクラスは以下のようになります。
			このクラスのコンストラクタでsetSingleRecordQueryメソッドにSampleTableのインスタンスを指定し、
			addMultiRecordQueryListメソッドでJoinTestTableのインスタンスを追加しています。
		</p>
		<div class="filecaption">Sample2Dao.javaの生成結果</div>
		<div class="wrappre">
			<pre>

	・
	・
	・

public class Sample2Dao extends QuerySetDao {

	・
	・
	・

	/**
	 * &#12469;&#12531;&#12503;&#12523;&#12486;&#12540;&#12502;&#12523;&#12290;
	 */
	private SampleTable sampleTable = null;

	/**
	 * &#12469;&#12531;&#12503;&#12523;&#12486;&#12540;&#12502;&#12523;&#12434;&#21462;&#24471;&#12375;&#12414;&#12377;&#12290;
	 * @return &#12469;&#12531;&#12503;&#12523;&#12486;&#12540;&#12502;&#12523;&#12290;
	 */
	public SampleTable getSampleTable() {
		return this.sampleTable;
	}

	/**
	 * Join&#12486;&#12473;&#12488;&#12486;&#12540;&#12502;&#12523;&#12290;
	 */
	private JoinTestTable joinTestTable = null;

	/**
	 * Join&#12486;&#12473;&#12488;&#12486;&#12540;&#12502;&#12523;&#12434;&#21462;&#24471;&#12375;&#12414;&#12377;&#12290;
	 * @return Join&#12486;&#12473;&#12488;&#12486;&#12540;&#12502;&#12523;&#12290;
	 */
	public JoinTestTable getJoinTestTable() {
		return this.joinTestTable;
	}


	/**
	 * &#12467;&#12531;&#12473;&#12488;&#12521;&#12463;&#12479;&#12290;
	 * @throws Exception &#20363;&#22806;&#12290;
	 */
	public Sample2Dao() {
		this.setComment(&quot;&#12469;&#12531;&#12503;&#12523;2&quot;);
		this.setListQuery(this.sampleTable = new SampleTable());
		this.setSingleRecordQuery(this.sampleTable = new SampleTable());
		this.addMultiRecordQueryList(this.joinTestTable = new JoinTestTable());

	}

	・
	・
	・

}

			</pre>
		</div>
		<p>
			上記Daoを参照したページを以下のように作成し、「Webリソース作成」を使用してこのページのHTMLを作成します。
		</p>
		<figure>
			<figcaption>Page Javaクラス作成</figcaption>
			<img src="page1.png" style="width:50%; height:50%;"/>
		</figure>
		<p>
			このページを実行し、EditFormを表示すると以下のようになります。
			SampleTableの1レコードに対してJoinTestTableは複数レコードが対応するため、
			JoinTestTableの複数レコードを編集するためのテーブルが展開されています。
			このテーブルはEditableHtmlTableというクラスで実現しているため、行の追加、削除、ドラグによる順序変更をサポートしています。
		</p>
		<figure>
			<figcaption>JoinTestTableも編集できるようにしたページ</figcaption>
			<img src="page2.png" style="width:50%; height:50%;"/>
		</figure>
		<p>
			QuerySetDaoクラスではsetSingleRecordQuery,addMultiRecordQueryListで登録された各問合せの
			mainTableに対する追加(insertメソッド)・更新(updateメソッド)・削除(deleteメソッド)処理を行う機能を持っています。
			そのため開発ツールで作成したコードだけで、データのメンテナンス機能が出来上がります。
		</p>
		<p>
			このパターンは見出し部と明細行のある伝票を登録するようなページに応用することができます。
		</p>
		<h3>複数レコード編集のページ</h3>
		<p>
			EditFormでテーブルの複数レコードを一度に編集することもできます。
			先ず次のようなテーブルを作成します。
		</p>
		<figure>
			<figcaption>複数レコード編集用テーブル</figcaption>
			<img src="mtable.png" style="width:50%; height:50%;"/>
		</figure>
		<p>
			このテーブルのCode1Fieldが同じ複数のレコードをまとめて編集するようにするため、
			Code1Fieldの毎のレコード件数を取得する問合せを作成します。
		</p>
		<figure>
			<figcaption>Code1Field毎のレコード数を求める問合せ</figcaption>
			<img src="mquery.png" style="width:50%; height:50%;"/>
		</figure>
		<p>
			この問合せは以下のSQLを生成し、Code1Field毎のレコード件数求める問合せになります。
		</p>
		<div class="filecaption">上記問合せに対応するSQL</div>
		<div class="wrappre">
			<pre>
select
	m.code1 as code1
	,count(m.multi_test_id) as multi_test_id
from multi_test as  m
	group by m.code1
			</pre>
		</div>
		<p>
			次の画面でDaoクラスを作成し、一覧取得用問合せに席に作成したMultiTestCode1Queryを指定します。
		</p>
		<p>
			編集フォーム用問合せは、Code1Fieldが同じ複数のレコードを編集するだめ、
			編集フォームを「複数レコードを編集」に設定し、編集対象にMultiTestTableを指定します。
			また編集データを限定するためのキーフィールドをチェックします。
			この場合code1をチェックします。
		</p>
		<figure>
			<figcaption>Daoクラスの作成</figcaption>
			<img src="mdao.png" style="width:50%; height:50%;"/>
		</figure>
		<p>
			「ページJavaクラス作成」をしてようして、このDaoを使用するするページクラスを作成します。
		</p>
		<figure>
			<figcaption>Pageクラスの作成</figcaption>
			<img src="mpage.png" style="width:50%; height:50%;"/>
		</figure>
		<p>
			ページのJavaクラスをデプロイした後、「Webリソース作成」を使用して、このページクラスからHTMLを作成してください。
			このページで検索を行うと以下のように、コード1毎の件数が表示されます。
		</p>
		<figure>
			<figcaption>複数レコード編集ページのQueryFormとQueryResultFormの表示</figcaption>
			<img src="mpage1.png" style="width:50%; height:50%;"/>
		</figure>
		<p>
			コード1のリンクをクリックすると、コード1の値が同じ複数のレコードをまとめて編集することができます。
		</p>
		<figure>
			<figcaption>複数レコード編集ページのEditFormの表示</figcaption>
			<img src="mpage2.png" style="width:50%; height:50%;"/>
		</figure>
		<p>
			ちなみにmulti_testテーブルのデータは以下のようになっています。
		</p>
		<figure>
			<figcaption>multi_testテーブルのデータ</figcaption>
			<img src="mdata.png" style="width:50%; height:50%;"/>
		</figure>
	</body>
</html>