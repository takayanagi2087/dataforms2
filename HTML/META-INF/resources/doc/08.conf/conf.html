<!DOCTYPE html>
<html>
	<head>
		<meta charset="UTF-8">
		<title>設定</title>
		<link type="text/css" href="../css/document.css" rel="stylesheet" />
	</head>
	<body>
		<h1><span>9.</span>設定</h1>
		<h2>WEB-INF/web.xml</h2>
		<p>
			dataforms2.jarの各種設定はWEB-INF/web.xmlにまとまっています。
			各種設定項目のコメントを参照し、適切に設定してください。
		</p>
		<p>
			以下に変更する機会の多い項目を解説します。
		</p>
		<h3>開発ツール関係</h3>
		<p>
			java-source-path,web-source-pathパラメータは開発ツールのJavaソースとHTMLやJavascriptソースを出力するパスを指定します。
			Eclipseのプロジェクトを作成したタイミングで、適切に設定してください。
		</p>
		<p>
			開発が完了したら開発ツールは不要になります。
			disable-developer-toolsをtrueに設定すれば、開発ツールを無効にすることができます。
			開発が完了しインターネットにシステムを公開する場合、開発ツールを無効にしておくことをお勧めします。
		</p>
		<h3>ブラウザのコンソールログ出力レベル</h3>
		<p>
			Javascriptのデバッグ時にconsole.log等を使用しデバック情報をブラウザのコンソールに出力するケースがあります。
			dataforms2.jarではこのconsoleのわりにloggerを使用します。
			loggerの使い方はconsoleと同じですが、client-log-levelパラメータでログレベルを指定することができます。
			logger.logを大量に記述したコードでも、client-log-levelをinfo以上にすることによって、
			ログの出力を抑制することができます。
		</p>
		<p>
			サーバサイドのログ出力はlog4j2を使用しています。そのの設定はlog4j2.xmlで行います。
		</p>
		<h3>dataforms2.jar内のWebリソースアクセス</h3>
		<p>
			dataforms2.jarの中にはあらかじめ定義されたページのHTMLやJavascriptが等のWebリソースが含まれています。
			Servlet 3.0以降ではjar中の/META-INF/resources以下のファイルがWebに公開されるようになっています。
			dataforms2.jarの内部処理はhttpを使用してdataforms2.jar内のWebリソースファイルをアクセスしています。
			つまり、https://hoge.jp/hoge/XXXPage.dfをアクセスすると、
			サーバ側の処理でhttps://hoge.jp/hoge/XXXPage.htmlというアクセスが発生します。
			この状態だと、内部のリソース取得でもhttpsが使用されるため暗号化処理が発生します。
			そのため、効率が良いとは言えません。
		</p>
		<p>
			Tomcat等のWebアプリケーションサーバではテスト用のhttpサービスが公開されています。
			Webリソースファイルの取得でこのhttpサービスを使用すれば効率化が図れます。
			Tomcatの場合web-resource-urlの設定を有効にします。
			この設定で、サーバーサイドの処理ではhttp://localhost:8080/hoge/XXXPage.htmlをアクセスするようになります。
		</p>
		<h3>データベース初期化時のユーザレベル</h3>
		<p>
			dfblank_xxx.warをプロジェクトにインポートし、データベースを初期化する場合、
			開発者レベルのユーザが登録されます。
			開発が終了したWebアプリケーションを公開する場合、最初に登録するユーザは管理者レベルでよくなります。
		</p>
		<p>
			initialize-user-levelにadminを指定すると、初期化時に管理者レベルのユーザが登録されるようになります。
		</p>
		<h3>データベース初期化を行うパッケージリスト</h3>
		<p>
			データベースの初期化のタイミングでdataforms.appパッケージ以下のTableクラスを見つけ出し、
			それに対応したテーブルを接続したデータベースに作成します。
			システムの開発作業では新規にパッケージを作成され、その中にテーブルクラスができてきます。
			完成したシステムを実行環境にデプロイするとき、
			その初期化処理で新たに追加されたテーブルを初期化するようにする必要があります。
		</p>
		<p>
			initialize-package-listパラメータにはTableクラスを含むパッケージのリストを","区切りで指定します。
			データベースの初期化処理は、このリストに指定されたパッケージ中のテーブルクラスに対応したテーブルを作成します。
		</p>
		<p>
			テーブルを含むパッケージを作成したら、必ずこのパラメータにパッケージを追加してください。
		</p>
		<h3>複数言語対応</h3>
		<p>
			dataforms2.jarはブラウザの言語設定が日本語(ja)の場合ページのhtmlを参照する場合、
			Hoge_ja.html(日本語用)をアクセスし存在しなければHoge.html(デフォルト言語用)をアクセスするようになっています。
			dataforms2.jar中に定義されているページのhtmlはデフォルト言語用と日本語用のページが用意されており、
			デフォルト言語用HTMLは英語のHTMLになっています。
		</p>
		<p>
			日本人のみを相手にするシステムではデフォルト言語用HTMLだけを作成しそれに日本語を記述するたけでOKですが、
			英語と日本語に対応しなければならない場合は、デフォルト言語用HTMLと日本語用HTMLを作成し、
			それぞれ英語と日本語で記述します。
		</p>
		<p>
			SelectFieldの選択肢を設定する列挙型管理テーブルには英語と日本語の設定欄が存在します。
			これ機能で選択肢も英語と日本語の登録が可能にっています。
		</p>
		<p>
			英語と日本語以外の言語に対応する場合、support-languageパラメータに言語コードを","区切りて追加します。
			この設定を行うと列挙型管理に追加された言語の設定欄が表示されます。
		</p>
		<p>
			全て英語のシステムを作成しても、日本語設定のブラウザでアクセスするとdataforms2.jar内のページは日本語で表示されてしまいます。
			このようなページも英語表示させたい場合は、fixed-languageパラメータにenを設定します。
			この設定を行うと、すべて英語ページが表示されます。
		</p>
		<h3>自動ログイン機能</h3>
		<p>
			auto-loginにenableを設定するとログイン画面に「ログインしたままにする。」というチェックボックスが表示されます。
			これをチェックした状態でログインすると、ログイン状態が維持されます。
		</p>
		<h3>IE11対応</h3>
		<p>
			dataforms2.jarではJavascriptを全てES6で記述しています。
			そのため基本的にIE11では動作しないものになっています。
		</p>
		<p>
			どうしてもIE11で動作させたい場合は、Balelを使用して自動的にES6のスクリプトをES5に変換して実行させます。
			TomcatをインストールしたサーバにBabelをインストールし、ie-supportパラメータを適切に設定してください。
		</p>
		<p>
			この設定でIEの初回アクセスで、ES6のスクリプトをES5に変換します。
			そのため初回のアクセスは非常に時間がかかりますが、二回目以降のアクセスは保存された変換結果を使用するため高速です。
		</p>
		<h3>データベース接続設定</h3>
		<p>
			context.xmlに設定されたデータソースの名前は"jdbc/dfdb"になっています。
			この名前が競合する環境では、この名前を変更する必要ができます。
			data-sourceパラメータを修正してください。
			jndi-prefixとdata-sourceパラメータの値を結合した文字列でJNDIデータソースを検索します。
		</p>
		<h3>メール送信設定</h3>
		<p>
			メールセッションの名称は"mail/Session"となっています。
			この名前が競合する場合web.xmlのmail-sessionパラメータで変更することができます。
		</p>
		<p>
			ユーザ登録時等でメールを送信する場合、そのfromのアドレスはmail-sessionパラメータで指定することができます。
		</p>
		<h3>デザイン切替</h3>
		<p>
			ページのフレームデザインは"/frame/default"中の*.htmlと*.cssで指定しています。
			このパスはframe-pathパラメータに設定されています。
			フレームのデザインを複数用意すると、サーバによってシステムのデザインを切り替えることができます。
		</p>
		<h3>既存ページの置き換え</h3>
		<p>
			dataforms2.jarではユーザ管理などの基本機能があらかじめ実装されています。
			これらの機能が非常にシンプルな機能であるため、別途高機能なページを作る必要が出てくる場合も存在します。
			この場合、既存の機能と新たに作ったページを置き換える必要が出てきます。
		</p>
		<p>
			page-overrideパラメータにページクラスの置き換えルールをJSON形式で指定することができます。
			この機能を使用して既存のページをdataforms.app.base.page.HiddenPageに置き換えると、
			対象のページを隠すことができます。
		</p>
		<p>
			外部ユーザ登録機能などを使用しない場合、この機能を使用して該当するページを隠してください。
		</p>
		<h2>context.xml</h2>
		<p>
			dfblank_xxx.warにはMETA-INF/context.xmlが存在しています。
			このファイルにはメールセッションの設定例とデータベースへの接続設定例が記述されています。
		</p>
		<h3>メール設定</h3>
		<p>
			一般公開し外部からのユーザ登録を許可するシステムの場合、メール送信機能を使用します。
			このような場合有効なSMTPサーバの情報を設定しください。
		</p>
		<h3>データベース設定</h3>
		<p>
			データベースの接続設定は組み込みApache Derbyの接続設定例が有効になっています。
			このままApache Derbyを使用する場合、データベースファイルのパスを適切に変更して使用してください。
		</p>
		<p>
			PostgreSQL等のデータベースを使用する場合、Apache Derbyの接続設定をコメントアウトし、
			PostgreSQL等の接続設定を有効にして適切に変更してください。
			この設定変更だけで、データベースを切り替えることができます。
		</p>
		<p>
			Apache Derby以外のデータベースの場合duplicateErrorMessageとforeignKeyErrorMessageという変数が定義されています。
			Apache DerbyのJDBCドライバには一意制約違反や外部キー制約違反等の例外が発生した場合、
			その制約名を取得するAPIが存在しています。
			しかし、その他のデータベースの場合そのようなAPIが存在しないため、
			例外のメッセージから制約の名称を取得するようになっています。
			このようなメッセージはOSの言語設定やデータベースのバージョンによって異なる可能性があるため、
			使用する環境に応じて適切に修正してください。
		</p>
		<h3>context.xmlの場所</h3>
		<p>
			META-INF/context.xmlはWebアプリケーション中の設定ファイルとなります。
			開発時やrunwarでスタンドアロン運用する場合はこのままで良いのですが、
			別途Tomcatを運用するサーバを用意する場合は$CATALINA_HOME/conf/context.xmlにこれらの設定を移動します。
			開発環境のTomcatにはテスト用のデータベース接続設定をおこない、
			運用環境のTomcatには本番用のデータベース接続設定を行っておきます。
			こうしておくと、開発環境で作成したwarファイルを運用環境のCATALINA_HOME/webapps/にコピーするだけでデプロイすることができます。
		</p>
	</body>
</html>